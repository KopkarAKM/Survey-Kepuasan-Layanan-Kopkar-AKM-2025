<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Survey Kopkar AKM 2025</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; height: 10px; background: #e2e8f0; border-radius: 12px; outline: none; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            width: 28px; height: 28px; border-radius: 50%; 
            background: #10b981; cursor: pointer; border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .survey-card { background: white; border-radius: 1.5rem; border: 1px solid #f1f5f9; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .step-btn { flex: none; font-size: 0.7rem; padding: 0.6rem 0.8rem; border-radius: 0.75rem; font-weight: 700; transition: all 0.2s; }
        
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-content { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="text-slate-800 pb-10">

    <header class="bg-slate-900 text-white sticky top-0 z-50 h-16 shadow-lg">
        <div class="max-w-6xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-white p-1 rounded-lg h-10 w-10 flex items-center justify-center overflow-hidden">
                    <img src="https://i.ibb.co.com/WvTwLMn5/image-1.png" alt="Logo Kopkar AKM" class="h-full w-auto object-contain">
                </div>
                <div>
                    <h1 class="font-bold text-sm md:text-base leading-tight tracking-tight">KOPKAR AKM</h1>
                    <p class="text-[9px] text-emerald-400 uppercase font-medium tracking-widest">Survey Anggota 2025</p>
                </div>
            </div>
            <div id="loc-badge" class="flex items-center gap-1.5 bg-slate-800 px-3 py-1.5 rounded-full text-[10px] text-white font-semibold border border-slate-700">
                <i data-lucide="map-pin" class="w-3 h-3 text-emerald-400"></i>
                <span id="loc-text">Lokasi?</span>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 mt-5">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-8 space-y-4">
                
                <nav class="bg-white p-1.5 rounded-2xl flex overflow-x-auto gap-1 shadow-sm border border-slate-100 no-scrollbar sticky top-20 z-40">
                    <button onclick="showStep(1)" id="btn-1" class="step-btn bg-emerald-500 text-white shadow-sm">1. PROFIL</button>
                    <button onclick="showStep(2)" id="btn-2" class="step-btn text-slate-400 hover:bg-slate-50">2. GCG</button>
                    <button onclick="showStep(3)" id="btn-3" class="step-btn text-slate-400 hover:bg-slate-50">3. USP</button>
                    <button onclick="showStep(4)" id="btn-4" class="step-btn text-slate-400 hover:bg-slate-50">4. DIGITAL</button>
                    <button onclick="showStep(5)" id="btn-5" class="step-btn text-slate-400 hover:bg-slate-50">5. TRAVEL</button>
                    <button onclick="showStep(6)" id="btn-6" class="step-btn text-slate-400 hover:bg-slate-50">6. RITEL</button>
                    <button onclick="showStep(7)" id="btn-7" class="step-btn text-slate-400 hover:bg-slate-50">7. SARAN</button>
                </nav>

                <div id="step-1" class="survey-card p-6 md:p-8 animate-content">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-emerald-100 p-2 rounded-xl text-emerald-600">
                            <i data-lucide="user-check"></i>
                        </div>
                        <h2 class="text-xl font-bold text-slate-800">Profil Responden</h2>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Nomor Anggota / NIK</label>
                            <input type="text" id="in-nik" inputmode="numeric" placeholder="Masukkan Nomor Anggota" class="w-full p-4 rounded-2xl border-none bg-slate-100 focus:ring-2 focus:ring-emerald-500 text-sm font-medium">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Nama Lengkap</label>
                            <input type="text" id="in-nama" placeholder="Masukkan Nama Lengkap" class="w-full p-4 rounded-2xl border-none bg-slate-100 focus:ring-2 focus:ring-emerald-500 text-sm font-medium">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Lokasi Kerja Utama</label>
                            <select onchange="updateProfile()" id="in-lokasi" class="w-full p-4 rounded-2xl border-none bg-slate-100 focus:ring-2 focus:ring-emerald-500 text-sm font-medium appearance-none">
                                <option value="">Pilih Lokasi</option>
                                <option>Kelanis</option><option>Dahai</option><option>KM 82</option><option>Kantor Tanjung</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Masa Keanggotaan</label>
                            <select id="in-masa" class="w-full p-4 rounded-2xl border-none bg-slate-100 focus:ring-2 focus:ring-emerald-500 text-sm font-medium appearance-none">
                                <option>Kurang dari 2 tahun</option><option>2 sampai 5 tahun</option><option>Lebih dari 5 tahun</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Unit Layanan Yang Sering Kamu Gunakan</label>
                            <select id="in-unit-fav" class="w-full p-4 rounded-2xl border-none bg-slate-100 focus:ring-2 focus:ring-emerald-500 text-sm font-medium appearance-none">
                                <option value="Semua">Gunakan Semua Layanan</option>
                                <option value="Simpan Pinjam">Simpan Pinjam</option>
                                <option value="Adamart">Adamart</option>
                                <option value="Travel">Travel</option>
                                <option value="Voucher">Voucher</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="validateAndGo(2)" class="w-full mt-8 bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-emerald-100 active:scale-95 transition">Mulai Isi Survei &rarr;</button>
                </div>

                <div id="dynamic-steps"></div>

                <div id="step-7" class="hidden survey-card p-6 animate-content">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <i data-lucide="message-circle" class="text-emerald-500"></i> Harapan Anggota
                    </h2>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Produk baru apa yang paling Kamu butuhkan tahun depan?</label>
                            <textarea id="in-harapan" class="w-full p-4 rounded-2xl border bg-slate-50 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" rows="2" placeholder="Contoh: KPR, Kredit Kendaraan..."></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Tuliskan satu hal utama yang harus segera diperbaiki pengelola.</label>
                            <textarea id="in-perbaikan" class="w-full p-4 rounded-2xl border bg-slate-50 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" rows="2"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Punya saran untuk meningkatkan nilai SHU tahun depan?</label>
                            <textarea id="in-saran-shu" class="w-full p-4 rounded-2xl border bg-slate-50 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="mt-10 flex gap-3">
                        <button onclick="showStep(6)" class="flex-1 py-4 font-bold text-slate-400">Kembali</button>
                        <button id="submit-btn" onclick="finishSurvey()" class="flex-[2] bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition">Kirim Penilaian</button>
                    </div>
                </div>

            </div>

            <div class="lg:col-span-4 space-y-4">
                <div class="bg-slate-900 text-white p-6 rounded-3xl shadow-xl overflow-hidden relative">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 relative z-10">Skor Indeks Kepuasan</p>
                    <div class="flex items-baseline gap-1 relative z-10">
                        <span class="text-6xl font-black text-emerald-400" id="total-score">0</span>
                        <span class="text-xl font-bold text-slate-500">%</span>
                    </div>
                    <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-emerald-500 opacity-10 rounded-full"></div>
                </div>

                <div class="bg-emerald-600 text-white p-5 rounded-3xl shadow-lg relative overflow-hidden">
                    <p class="text-[10px] font-bold text-emerald-100 uppercase tracking-widest mb-1">Rata-rata Komunitas</p>
                    <div class="flex items-baseline gap-1">
                        <span class="text-4xl font-black" id="global-score">--</span>
                        <span class="text-base font-bold text-emerald-200">%</span>
                    </div>
                    <p class="text-[8px] mt-2 text-emerald-100 font-medium" id="global-count">Memuat data...</p>
                </div>

                <div class="survey-card p-5">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">Peta Kepuasan</h4>
                    <div style="height: 220px;"><canvas id="radarChart"></canvas></div>
                </div>
            </div>

        </div>
    </main>

    <div id="report-modal" class="fixed inset-0 bg-slate-900/95 backdrop-blur-xl z-[100] hidden items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] p-8 max-w-lg w-full text-center shadow-2xl animate-slide-up">
            <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-5">
                <i data-lucide="check-circle-2" class="w-10 h-10"></i>
            </div>
            <h3 class="text-2xl font-black text-slate-900">Survei Berhasil!</h3>
            <p class="text-slate-400 text-xs mt-1">Aspirasi Kamu telah tercatat secara permanen.</p>
            
            <div class="bg-slate-50 rounded-3xl p-5 text-left my-6 border border-slate-100">
                <p class="text-[10px] font-black text-emerald-600 uppercase mb-3 tracking-widest flex items-center gap-1.5">
                    <i data-lucide="zap" class="w-3 h-3"></i> Resume Strategis (Local Engine)
                </p>
                <div id="insight-list" class="text-xs text-slate-600 space-y-3 leading-relaxed font-medium"></div>
            </div>

            <button onclick="location.reload()" class="w-full bg-slate-900 text-white py-4.5 rounded-2xl font-bold shadow-lg">Kembali ke Beranda</button>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxWIb8yIRRoqcuvgogEpqaIJr7RtW5AGp1H2-2q3XLoOlyC_f4X4Do4eBkkgatazX_3Zg/exec';
        let chart;
        const surveyData = { gcg: [3,3,3,3,3], usp: [3,3,3,3,3,3], dig: [3,3,3,3], trv: [3,3,3,3], ret: [3,3,3,3] };

        const blueprint = {
            gcg: { title: "Tata Kelola & Kinerja Pengurus", qs: [
                "Pengurus mengelola aset dengan jujur & integritas",
                "Laporan keuangan bulanan mudah diakses & dipahami",
                "Jawaban pengurus memuaskan saat RAT/Komunikasi",
                "Kebijakan koperasi sudah adil & tidak memihak",
                "Aman menyimpan dana karena pengawasan ketat"
            ]},
            usp: { title: "Unit Simpan Pinjam (USP)", qs: [
                "Proses pengajuan pinjaman tidak sulit (Dokumen)",
                "Pencairan pinjaman tepat waktu sesuai janji",
                "Suku bunga pinjaman masih kompetitif",
                "Penjelasan biaya admin & premi asuransi jelas",
                "Penarikan simpanan sukarela mudah & lancar",
                "Koperasi memberi solusi kendala potong gaji"
            ]},
            dig: { title: "Transformasi Digital (Aplikasi)", qs: [
                "Aplikasi mobile mudah digunakan di Android",
                "Cek saldo & sisa pinjaman diperbarui tepat waktu",
                "Simulasi pinjaman aplikasi sesuai potongan gaji riil",
                "Notifikasi transaksi membantu pantau aktivitas"
            ]},
            trv: { title: "Unit Kopkarindo Travel", qs: [
                "Harga paket sebanding kualitas hotel & transportasi",
                "Staf travel membantu pengurusan paspor & visa",
                "Program talangan umroh membantu perencanaan ibadah",
                "Jadwal keberangkatan & kepulangan tepat waktu"
            ]},
            ret: { title: "Unit Ritel (Adamart & Voucher)", qs: [
                "Barang kebutuhan pokok di Adamart selalu tersedia",
                "Jam operasional toko sesuai kebutuhan kerja site",
                "Proses redeem/penggunaan voucher belanja cepat",
                "Biaya jasa voucher 5% sesuai dengan kemudahan"
            ]}
        };

        window.onload = () => {
            renderSteps();
            lucide.createIcons();
            initChart();
            calculateScores();
            setTimeout(fetchGlobalStats, 800); 
        };

        function validateAndGo(step) {
            const nik = document.getElementById('in-nik').value.trim();
            const nama = document.getElementById('in-nama').value.trim();
            const lokasi = document.getElementById('in-lokasi').value;
            
            if (!nik || !nama || !lokasi) {
                alert("Harap isi NIK, Nama, dan Lokasi Kamu.");
                return;
            }
            showStep(step);
        }

        function renderSteps() {
            let html = "";
            const keys = Object.keys(blueprint);
            keys.forEach((key, idx) => {
                const stepIdx = idx + 2;
                const nextStep = stepIdx + 1;
                const prevStep = stepIdx - 1;
                
                html += `
                <div id="step-${stepIdx}" class="hidden survey-card p-6 animate-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-slate-800">${blueprint[key].title}</h2>
                        <span class="text-[10px] font-black bg-slate-100 text-slate-500 px-2 py-1 rounded-lg uppercase tracking-widest">${stepIdx}/7</span>
                    </div>
                    <div class="space-y-10">
                        ${blueprint[key].qs.map((q, i) => `
                            <div class="space-y-4">
                                <div class="flex justify-between items-start gap-4">
                                    <label class="text-sm font-semibold text-slate-700 leading-snug">${q}</label>
                                    <span class="text-xs font-black text-emerald-600 bg-emerald-50 px-2.5 py-1 rounded-xl whitespace-nowrap" id="val-${key}-${i}">3/5</span>
                                </div>
                                <div class="px-1">
                                    <input type="range" min="1" max="5" value="3" data-cat="${key}" data-idx="${i}" class="q-slider">
                                    <div class="flex justify-between mt-2">
                                        <span class="text-[8px] text-slate-300 font-bold uppercase tracking-widest">Buruk</span>
                                        <span class="text-[8px] text-emerald-400 font-bold uppercase tracking-widest">Sangat Baik</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-10 flex gap-3">
                        <button onclick="showStep(${prevStep})" class="flex-1 py-4 font-bold text-slate-400 bg-slate-50 rounded-2xl active:bg-slate-100 transition">Kembali</button>
                        <button onclick="showStep(${nextStep})" class="flex-[2] bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-emerald-100 active:scale-95 transition">Berikutnya</button>
                    </div>
                </div>`;
            });
            document.getElementById('dynamic-steps').innerHTML = html;
            
            document.querySelectorAll('.q-slider').forEach(s => {
                s.oninput = (e) => {
                    const { cat, idx } = e.target.dataset;
                    const val = parseInt(e.target.value);
                    document.getElementById(`val-${cat}-${idx}`).innerText = val + "/5";
                    surveyData[cat][idx] = val;
                    calculateScores();
                };
            });
        }

        async function fetchGlobalStats() {
            try {
                const response = await fetch(`${scriptURL}?t=${Date.now()}`);
                if (!response.ok) throw new Error();
                const stats = await response.json();
                document.getElementById('global-score').innerText = stats.average || "0";
                document.getElementById('global-count').innerText = `Berdasarkan ${stats.count || 0} Responden`;
            } catch (e) {
                document.getElementById('global-count').innerText = "Data sedang disinkronisasi";
            }
        }

        function showStep(s) {
            for(let i=1; i<=7; i++) {
                const el = document.getElementById(`step-${i}`);
                if(el) el.classList.add('hidden');
                const btn = document.getElementById(`btn-${i}`);
                if(btn) btn.className = "step-btn text-slate-400 hover:bg-slate-50";
            }
            document.getElementById(`step-${s}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`btn-${s}`);
            if(activeBtn) activeBtn.className = "step-btn bg-emerald-500 text-white shadow-md scale-105";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateProfile() {
            document.getElementById('loc-text').innerText = document.getElementById('in-lokasi').value || "Lokasi?";
        }

        function calculateScores() {
            const avg = (arr) => arr.reduce((a,b)=>a+b,0)/arr.length;
            const res = [avg(surveyData.gcg), avg(surveyData.usp), avg(surveyData.dig), avg(surveyData.trv), avg(surveyData.ret)];
            const total = Math.round((res.reduce((a,b)=>a+b,0)/5/5)*100);
            document.getElementById('total-score').innerText = total;
            if (chart) { chart.data.datasets[0].data = res; chart.update(); }
        }

        function initChart() {
            chart = new Chart(document.getElementById('radarChart').getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ['GCG', 'USP', 'Digital', 'Travel', 'Ritel'],
                    datasets: [{
                        data: [3, 3, 3, 3, 3],
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderColor: '#10b981',
                        borderWidth: 3,
                        pointBackgroundColor: '#10b981',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { r: { min: 0, max: 5, ticks: { display: false }, pointLabels: { font: { size: 9, weight: '800' }, color: '#94a3b8' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        async function finishSurvey() {
            const btn = document.getElementById('submit-btn');
            btn.innerHTML = "Sedang mengirim data...";
            btn.disabled = true;
            
            const payload = {
                nik: document.getElementById('in-nik').value,
                nama: document.getElementById('in-nama').value,
                lokasi: document.getElementById('in-lokasi').value,
                masa_anggota: document.getElementById('in-masa').value,
                unit_layanan: document.getElementById('in-unit-fav').value,
                gcg: surveyData.gcg, usp: surveyData.usp, dig: surveyData.dig, trv: surveyData.trv, ret: surveyData.ret,
                total_skor: document.getElementById('total-score').innerText,
                harapan_produk: document.getElementById('in-harapan').value,
                perbaikan_utama: document.getElementById('in-perbaikan').value,
                saran_shu: document.getElementById('in-saran-shu').value
            };

            try {
                await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                
                const avgVal = (arr) => arr.reduce((a,b)=>a+b,0)/arr.length;
                const insights = [];
                if (avgVal(surveyData.gcg) < 3.8) insights.push("Tingkatkan transparansi pengelolaan dana kepada anggota.");
                if (avgVal(surveyData.usp) < 3.8) insights.push("Perlu penyederhanaan birokrasi pencairan pinjaman.");
                if (avgVal(surveyData.dig) < 3.8) insights.push("Optimalkan fitur simulasi pinjaman agar lebih akurat.");
                if (payload.perbaikan_utama.length > 5) insights.push("Satu perbaikan utama Kamu telah masuk daftar evaluasi.");
                if (insights.length === 0) insights.push("Kinerja sangat memuaskan, pertahankan integritas Kamu.");

                document.getElementById('insight-list').innerHTML = insights.map(i => `<p class="flex gap-2"><span>â€¢</span> <span>${i}</span></p>`).join('');
                document.getElementById('report-modal').style.display = 'flex';
                lucide.createIcons();
            } catch (e) { 
                alert("Gagal mengirim. Coba lagi."); 
                btn.innerHTML = "Kirim Ulang"; 
                btn.disabled = false; 
            }
        }
    </script>
</body>
</html>
